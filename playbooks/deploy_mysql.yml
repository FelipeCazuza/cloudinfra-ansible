---
- name: Garantir que o banco GLPI (MariaDB) está operacional
  hosts: banco
  become: yes
  tasks:

    - name: Garantir que o serviço MariaDB está instalado
      ansible.builtin.yum:
        name: mariadb-server
        state: present

    - name: Garantir que o serviço MariaDB está iniciado e habilitado
      ansible.builtin.systemd:
        name: mariadb
        state: started
        enabled: yes

    - name: Reiniciar MariaDB se estiver parado
      ansible.builtin.shell: |
        if ! systemctl is-active --quiet mariadb; then
          echo "MariaDB parado, reiniciando..."
          systemctl restart mariadb
        fi
      register: restart_mysql
      changed_when: restart_mysql.stdout | length > 0

    - name: Verificar se o banco está escutando na porta 3306
      ansible.builtin.shell: "ss -tuln | grep :3306 || true"
      register: mysql_status
      changed_when: false

    - name: Exibir status da porta do banco
      ansible.builtin.debug:
        msg: "MariaDB escutando: {{ 'SIM' if mysql_status.stdout else 'NÃO' }}"
